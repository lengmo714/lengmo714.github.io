let allData=[],pieChart=null,lineChart=null;function handleFiles(e){const t=e.target.files;document.getElementById("result").innerHTML="",allData=[];const a=new Set,n=new Set,l=new Set,o=new Set,r=new Set;Array.from(t).forEach((e=>{if(e.name.endsWith(".xlsx")||e.name.endsWith(".xls")){const t=new FileReader;t.onload=function(e){const t=new Uint8Array(e.target.result),c=XLSX.read(t,{type:"array"}),d=c.SheetNames[0],s=c.Sheets[d];XLSX.utils.sheet_to_json(s).forEach((e=>{void 0!==e.SKU&&(e.SKU=String(e.SKU),n.add(e.SKU)),void 0!==e["时间"]&&a.add(e["时间"]),void 0!==e["一级类目"]&&l.add(e["一级类目"]),void 0!==e["二级类目"]&&o.add(e["二级类目"]),void 0!==e["三级类目"]&&r.add(e["三级类目"]),allData.push(e)})),updateSelectOptions(a,n,l,o,r),filterData()},t.readAsArrayBuffer(e)}}))}function updateSelectOptions(e,t,a,n,l){const o=document.getElementById("timeSelect"),r=document.getElementById("skuSelect"),c=document.getElementById("category1Select"),d=document.getElementById("category2Select"),s=document.getElementById("category3Select");o.innerHTML='<option value="">全部</option>',r.innerHTML='<option value="">全部</option>',c.innerHTML='<option value="">全部</option>',d.innerHTML='<option value="">全部</option>',s.innerHTML='<option value="">全部</option>',e.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)})),t.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)})),a.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,c.appendChild(t)})),n.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,d.appendChild(t)})),l.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,s.appendChild(t)}))}function filterData(){const e=document.getElementById("timeSelect").value,t=document.getElementById("startDate").value,a=document.getElementById("endDate").value,n=document.getElementById("skuSelect").value,l=document.getElementById("category1Select").value,o=document.getElementById("category2Select").value,r=document.getElementById("category3Select").value,c=allData.filter((c=>!(""!==e&&c["时间"]!==e||!(""===t||new Date(c["时间"])>=new Date(t))||!(""===a||new Date(c["时间"])<=new Date(a))||""!==n&&c.SKU!==n||""!==l&&c["一级类目"]!==l||""!==o&&c["二级类目"]!==o||""!==r&&c["三级类目"]!==r)));c.sort(((e,t)=>{const a=new Date(e["时间"]);return new Date(t["时间"])-a}));document.getElementById("result").innerHTML=generateTable(c),clearPieChart(),clearLineChart()}function generateTable(e){if(0===e.length)return"<p>暂无数据。</p>";let t="<table><thead><tr>";const a=Object.keys(e[0]);return a.forEach((e=>{let a=e;switch(e){case"时间":a="时间";break;case"浏览量":a="浏览量";break;case"访客数":a="访客数";break;case"人均浏览量":a="人均浏览量";break;case"平均停留时长":a="平均停留时长";break;case"成交人数":a="成交人数";break;case"成交转化率":a="成交转化率";break;case"成交单量":a="成交单量";break;case"成交商品件数":a="成交商品件数";break;case"成交金额":a="成交金额";break;case"成交客单价":a="成交客单价";break;case"加购人数":a="加购人数";break;case"加购商品件数":a="加购商品件数";break;case"加购转化率":a="加购转化率";break;case"SKU":a="SKU";break;case"一级类目":a="一级类目";break;case"二级类目":a="二级类目";break;case"三级类目":a="三级类目"}t+=`<th>${a}</th>`})),t+="</tr></thead><tbody>",e.forEach(((n,l)=>{t+="<tr>",a.forEach((a=>{let o=n[a],r="";if(l>=0){const t=e.find((e=>e.SKU===n.SKU&&new Date(e["时间"]).getTime()<new Date(n["时间"]).getTime()));if(t&&(r=t[a],"浏览量"===a||"访客数"===a||"人均浏览量"===a||"平均停留时长"===a||"成交人数"===a||"成交单量"===a||"成交金额"===a||"成交转化率"===a||"加购人数"===a||"加购商品件数"===a||"成交客单价"===a||"加购转化率"===a||"成交商品件数"===a)){const e=parseFloat(o),t=parseFloat(r);isNaN(e)||isNaN(t)||(e>t?o=`<span class="increase">${o}<span class="arrow up">&#8593;</span></span>`:e<t&&(o=`<span class="decrease">${o}<span class="arrow down">&#8595;</span></span>`))}}else o=`<span>${o}</span>`;t+=`<td>${o}</td>`})),t+="</tr>"})),t+="</tbody></table>",t}function calculateAndDrawPieChart(){clearPieChart();const e=document.getElementById("timeSelect").value,t=document.getElementById("startDate").value,a=document.getElementById("endDate").value;let n=allData.filter((n=>(""===e||n["时间"]===e)&&(""===t||new Date(n["时间"])>=new Date(t))&&(""===a||new Date(n["时间"])<=new Date(a))));const l={};n.forEach((e=>{const t=e["三级类目"],a=parseFloat(e["成交金额"])||0;t&&!isNaN(a)&&(l[t]?l[t]+=a:l[t]=a)}));const o=Object.values(l).reduce(((e,t)=>e+t),0),r={};Object.keys(l).forEach((e=>{const t=l[e]/o*100;r[e]=t.toFixed(2)}));const c=Object.keys(r),d=Object.values(r),s=document.getElementById("pieChartContainer");s.innerHTML='<canvas id="pieChartCanvas"></canvas>';const i=document.getElementById("pieChartCanvas").getContext("2d");pieChart=new Chart(i,{type:"pie",data:{labels:c,datasets:[{label:"三级类目成交金额占比",data:d,backgroundColor:["rgba(255, 99, 132, 0.7)","rgba(54, 162, 235, 0.7)","rgba(255, 206, 86, 0.7)","rgba(75, 192, 192, 0.7)","rgba(153, 102, 255, 0.7)","rgba(255, 159, 64, 0.7)","rgba(255, 99, 132, 0.7)"],borderColor:["rgba(255, 99, 132, 1)","rgba(54, 162, 235, 1)","rgba(255, 206, 86, 1)","rgba(75, 192, 192, 1)","rgba(153, 102, 255, 1)","rgba(255, 159, 64, 1)","rgba(255, 99, 132, 1)"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},tooltip:{callbacks:{label:function(e){return`${c[e.dataIndex]}: 金额:${l[e.label]}  占比:${d[e.dataIndex]}%`}}}}}}),scrollToElement(s)}function calculateAndDrawLineCharts(){clearLineChart();const e=document.getElementById("skuSelect").value;let t=allData.filter((t=>""===e||t.SKU===e));const a=t.map((e=>e["时间"])),n=t.map((e=>parseFloat(e["访客数"])||0)),l=t.map((e=>parseFloat(e["成交单量"])||0)),o=document.getElementById("lineChartContainer");o.style.display="block",o.innerHTML='<canvas id="lineChartCanvas"></canvas>';const r=document.getElementById("lineChartCanvas").getContext("2d");lineChart=new Chart(r,{type:"line",data:{labels:a,datasets:[{label:"访客数",data:n,borderColor:"rgba(54, 162, 235, 0.7)",backgroundColor:"rgba(54, 162, 235, 0.2)",fill:!1},{label:"成交单量",data:l,borderColor:"rgba(255, 99, 132, 0.7)",backgroundColor:"rgba(255, 99, 132, 0.2)",fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},tooltip:{mode:"index",intersect:!1}},scales:{x:{display:!0,title:{display:!0,text:"时间"}},y:{display:!0,title:{display:!0,text:"数量"}}}}}),scrollToElement(o)}function scrollToElement(e){window.scrollTo({top:e.offsetTop,behavior:"smooth"})}function scrollToTop(){window.scrollTo({top:0,behavior:"smooth"})}function clearPieChart(){pieChart&&(pieChart.destroy(),pieChart=null)}function clearLineChart(){lineChart&&(lineChart.destroy(),lineChart=null)}document.getElementById("fileInput").addEventListener("change",handleFiles,!1),document.getElementById("timeSelect").addEventListener("change",filterData),document.getElementById("startDate").addEventListener("change",filterData),document.getElementById("endDate").addEventListener("change",filterData),document.getElementById("skuSelect").addEventListener("change",filterData),document.getElementById("category1Select").addEventListener("change",filterData),document.getElementById("category2Select").addEventListener("change",filterData),document.getElementById("category3Select").addEventListener("change",filterData);