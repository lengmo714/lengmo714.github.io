<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>天气预报</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .controls {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .weather-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .weather-table th,
        .weather-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .weather-table th {
            background-color: #f2f2f2;
        }

        #error-message {
            color: red;
        }
    </style>
</head>

<body>
    <h1>天气预报</h1>
    <div class="controls">
        <label for="city-select">选择城市:</label>
        <select id="city-select" onchange="getWeather()">
            <option value="">全部城市</option>
            <option value="101010100">北京市</option>
            <option value="101280601">深圳市</option>
            <option value="101280101">广州市</option>
            <option value="101020100">上海市</option>
            <option value="101270101">成都市</option>
            <option value="101190401">苏州市</option>
            <option value="101200101">武汉市</option>
            <option value="101110101">西安市</option>
            <option value="101210101">杭州市</option>
            <option value="101120401">德州市</option>
            <option value="101070101">沈阳市</option>
        </select>
        <label for="date-select">选择日期:</label>
        <input type="date" id="date-select" onchange="getWeather()">
        <button id="fetch-weather-btn" onclick="getWeather()">获取天气</button>
    </div>
    <div id="weather-container"></div>
    <div id="error-message"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <script>
        const apiKey = 'f525128c648945b0a1ba33a29db27290';
        const cities = [
            { name: '北京市', id: '101010100' },
            { name: '深圳市', id: '101280601' },
            { name: '广州市', id: '101280101' },
            { name: '上海市', id: '101020100' },
            { name: '成都市', id: '101270101' },
            { name: '苏州市', id: '101190401' },
            { name: '武汉市', id: '101200101' },
            { name: '西安市', id: '101110101' },
            { name: '杭州市', id: '101210101' },
            { name: '德州市', id: '101120401' },
            { name: '沈阳市', id: '101070101' },
        ];

        async function getWeather() {
            const citySelect = document.getElementById('city-select');
            const cityId = citySelect.value;
            const dateSelect = document.getElementById('date-select');
            let selectedDate = dateSelect.value;

            // 如果用户没有选择日期，使用当前日期作为默认值
            if (!selectedDate) {
                selectedDate = new Date().toISOString().split('T')[0];  // 获取当前日期
            }

            const weatherContainer = document.getElementById('weather-container');
            weatherContainer.innerHTML = '';

            for (const city of cities) {
                if (!cityId || city.id === cityId) {
                    await fetchWeather(city, selectedDate);
                    // 获取去年同一天的日期
                    const lastYearDate = getLastYearDate(selectedDate);
                    await fetchWeatherForLastYear(city, lastYearDate);
                }
            }
        }

        function getLastYearDate(dateString) {
            const date = new Date(dateString);
            date.setFullYear(date.getFullYear() - 1);
            return date.toISOString().split('T')[0]; // 返回 'YYYY-MM-DD' 格式的日期
        }

        async function fetchWeather(city, selectedDate) {
            try {
                const response = await fetch(`https://api.qweather.com/v7/weather/30d?location=${city.id}&key=${apiKey}`);
                const data = await response.json();

                if (data.code === '200') {
                    const filteredData = selectedDate ? data.daily.filter(day => day.fxDate === selectedDate) : data.daily;
                    displayWeather(city.name, filteredData, selectedDate);
                } else {
                    showError(`获取${city.name}的天气数据失败: ${data.message}`);
                }
            } catch (error) {
                showError(`请求${city.name}的天气数据失败: ${error.message}`);
            }
        }

        async function fetchWeatherForLastYear(city, lastYearDate) {
            try {
                const response = await fetch(`https://api.qweather.com/v7/weather/30d?location=${city.id}&key=${apiKey}`);
                const data = await response.json();

                if (data.code === '200') {
                    const filteredData = data.daily.filter(day => day.fxDate === lastYearDate);
                    displayWeather(city.name, filteredData, lastYearDate, true);
                } else {
                    showError(`获取${city.name}去年的天气数据失败: ${data.message}`);
                }
            } catch (error) {
                showError(`请求${city.name}去年的天气数据失败: ${error.message}`);
            }
        }

        function displayWeather(cityName, daily, selectedDate, isLastYear = false) {
            const weatherContainer = document.getElementById('weather-container');
            const table = document.createElement('table');
            table.classList.add('weather-table');

            const caption = document.createElement('caption');
            caption.textContent = `${cityName} (${selectedDate ? selectedDate : '最近天气'}) ${isLastYear ? '(去年)' : ''}`;
            table.appendChild(caption);

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['日期', '天气', '最高温度', '最低温度'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            daily.forEach(day => {
                const row = document.createElement('tr');
                [day.fxDate, day.textDay, day.tempMax, day.tempMin].forEach(text => {
                    const td = document.createElement('td');
                    td.textContent = text;
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            weatherContainer.appendChild(table);
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
        }
    </script>
</body>

</html>
