<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>检测设备与浏览器并跳转 Safari</title>
  <script>
    function detectDeviceAndBrowser() {
      const ua = navigator.userAgent;
      const uaLower = ua.toLowerCase();

      let device = '未知设备';
      if (/iphone/i.test(ua)) device = 'iPhone';
      else if (/ipad/i.test(ua)) device = 'iPad';
      else if (/ipod/i.test(ua)) device = 'iPod';
      else if (/android/i.test(ua)) device = 'Android';
      else if (/windows/i.test(ua)) device = 'Windows 电脑';
      else if (/macintosh/i.test(ua)) device = 'Mac 电脑';

      let browser = '未知浏览器';
      if (/micromessenger/i.test(ua)) browser = '微信内置浏览器';
      else if (/fbav|fban/i.test(ua)) browser = 'Facebook 内置浏览器';
      else if (/telegram/i.test(ua)) browser = 'Telegram 内置浏览器';
      else if (/crios/i.test(ua)) browser = 'Chrome iOS';
      else if (/fxios/i.test(ua)) browser = 'Firefox iOS';
      else if (/edgios/i.test(ua)) browser = 'Edge iOS';
      else if (/safari/i.test(ua) && !/chrome|crios|fxios|edgios/i.test(ua)) browser = 'Safari';
      else if (/chrome/i.test(ua)) browser = 'Chrome';
      else if (/firefox/i.test(ua)) browser = 'Firefox';
      else if (/edg/i.test(ua)) browser = 'Edge';

      return { device, browser, ua };
    }

    function tryRedirectToSafari() {
      const info = detectDeviceAndBrowser();
      const ua = navigator.userAgent.toLowerCase();
      const isIOS = /iphone|ipad|ipod/.test(ua);
      const isSafari = /safari/.test(ua) && !/crios|fxios|edgios|fbav|fban|instagram|line|mqqbrowser|micromessenger|telegram/.test(ua);
      const currentUrl = window.location.href;
      const hasRedirected = currentUrl.includes('from=nosafari');

      // 输出设备与浏览器信息
      document.body.innerHTML = `
        <h2>设备与浏览器检测</h2>
        <p><strong>设备：</strong>${info.device}</p>
        <p><strong>浏览器：</strong>${info.browser}</p>
        <p><strong>User-Agent：</strong>${info.ua}</p>
        <p id="status" style="color:blue;margin-top:20px;">检测完成。</p>
      `;

      // 跳转逻辑：iOS 且不是 Safari，且未跳转过
      if (isIOS && !isSafari && !hasRedirected) {
        const targetUrl = currentUrl.includes('?')
          ? currentUrl + '&from=nosafari'
          : currentUrl + '?from=nosafari';

        document.getElementById('status').textContent = '检测到非 Safari，正在为您打开 Safari...';

        // 延迟执行以提高兼容性
        setTimeout(() => {
          window.location.href = targetUrl;
        }, 800);
      } else if (isIOS && isSafari) {
        document.getElementById('status').textContent = '当前已在 Safari 中，无需跳转。';
      }
    }

    window.addEventListener('DOMContentLoaded', tryRedirectToSafari);
  </script>
</head>
<body>
  <p>正在检测设备与浏览器...</p>
</body>
</html>
